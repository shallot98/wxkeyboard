name: Build Tweak

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies (brew)
        run: |
          brew update
          brew install ldid dpkg fakeroot gnu-sed wget xz unzip

      - name: Install Theos
        run: |
          export THEOS="$HOME/theos"
          git clone --depth=1 https://github.com/theos/theos.git "$THEOS"
          echo "THEOS=$THEOS" >> "$GITHUB_ENV"

      - name: Install iOS 16.1 SDK
        shell: bash
        run: |
          mkdir -p "$THEOS/sdks"
          set -e
          URL_PRIMARY="https://github.com/theos/sdks/releases/latest/download/iPhoneOS16.1.sdk.tar.xz"
          URL_FALLBACK="https://github.com/theos/sdks/releases/download/20230603/iPhoneOS16.1.sdk.tar.xz"
          TMPFILE="$THEOS/sdks/iPhoneOS16.1.sdk.tar.xz"
          if ! curl -L --fail -o "$TMPFILE" "$URL_PRIMARY"; then
            echo "Primary SDK URL failed, trying fallback..."
            curl -L --fail -o "$TMPFILE" "$URL_FALLBACK"
          fi
          tar -xf "$TMPFILE" -C "$THEOS/sdks"
          rm -f "$TMPFILE"
          ls -la "$THEOS/sdks"

      - name: Build (rootless)
        run: |
          make clean package THEOS_PACKAGE_SCHEME=rootless

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: packages/*.deb
          if-no-files-found: error
